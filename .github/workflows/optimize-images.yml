# .github/workflows/optimize-images.yml
name: 📷 Optimize & Resize Images

on:
  push:
    paths:
      - 'season*/**/*.jpg'
      - 'season*/**/*.jpeg'
      - 'season*/**/*.png'
      - 'season*/**/*.webp'
      - '.github/workflows/optimize-images.yml'

permissions:
  contents: write  # чтобы можно было коммитить оптимизированные файлы

jobs:
  optimize:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Resize oversized images
      uses: petems/image-resizer-gh-action@master
      with:
        target: '.'
        widthLimit: 1920
        heightLimit: 1080

    - name: Compress images (Calibre)
      id: calibre
      uses: calibreapp/image-actions@main
      with:
        githubToken: ${{ secrets.GITHUB_TOKEN }}
        compressOnly: true    # <— важный флаг для запуска на push

    - name: Debug
      run: |
        git status
        git diff --name-only

    - name: Commit optimized images
      uses: stefanzweifel/git-auto-commit-action@v4
      with:
        commit_message: '[ci skip] optimize & resize images'
        file_pattern: |
            **/season*/**/*.{jpg,jpeg,png,webp}
